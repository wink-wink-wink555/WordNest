<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•è¯çŸ¥è¯†å›¾è°± - å•è¯è‡ªæµ‹ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <!-- å¼•å…¥Interå­—ä½“ï¼ˆè‹¹æœé£æ ¼çš„å¼€æºå­—ä½“ï¼‰å’Œæ€æºé»‘ä½“ -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- ä¿®æ”¹vis.jsåŠ è½½æ–¹å¼ï¼Œä½¿ç”¨å¤šå±‚æ•…éšœè½¬ç§»æ–¹æ¡ˆ -->
    <script>
        // å…¨å±€å˜é‡ç”¨äºè·Ÿè¸ªåŠ è½½çŠ¶æ€
        window.visJsLoaded = false;
    </script>
    
    <!-- é¦–é€‰CDNæºï¼Œæ·»åŠ crossoriginå±æ€§ -->
    <script src="https://cdn.jsdelivr.net/npm/vis-network@9.1.2/dist/vis-network.min.js" 
            crossorigin="anonymous"
            onerror="handleVisJsLoadError('ä¸»è¦CDN')" 
            onload="window.visJsLoaded = true; console.log('ä¸»è¦CDNæˆåŠŸåŠ è½½vis.jsï¼Œç‰ˆæœ¬:', vis.version || 'æœªçŸ¥')"></script>
    
    <!-- æ·»åŠ æœ¬åœ°å¤‡ç”¨æ–¹æ¡ˆ -->
    <script>
        // å°è¯•æœ€åä»æœ¬åœ°åŠ è½½vis.jsï¼ˆå¦‚æœä¹‹å‰çš„æ–¹æ³•éƒ½å¤±è´¥ï¼‰
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(function() {
                if (!window.visJsLoaded) {
                    console.log("å°è¯•ä»æœ¬åœ°åŠ è½½vis.js");
                    let script = document.createElement('script');
                    script.src = "{{ url_for('static', filename='js/vis-network.min.js') }}";
                    script.onload = function() {
                        window.visJsLoaded = true;
                        console.log("æœ¬åœ°vis.jsåŠ è½½æˆåŠŸ");
                        // å¦‚æœæœ‰å›¾è°±æ•°æ®ï¼Œå°è¯•é‡æ–°åˆ›å»ºç½‘ç»œå›¾
                        if ({{ has_graph_data|tojson }}) {
                            try {
                                if (typeof createNetwork === 'function') {
                                    {% if graph_data_json is defined %}
                                    const graphData = {{ graph_data_json|safe }};
                                    createNetwork(graphData);
                                    {% endif %}
                            } catch (e) {
                                console.error("é‡æ–°åˆ›å»ºç½‘ç»œå›¾å¤±è´¥:", e);
                            }
                        }
                    };
                    script.onerror = function() {
                        console.error("æœ¬åœ°vis.jsåŠ è½½å¤±è´¥");
                        alert("æ— æ³•åŠ è½½å¯è§†åŒ–åº“ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–è”ç³»ç®¡ç†å‘˜ã€‚");
                    };
                    document.head.appendChild(script);
                }
            }, 2000);
        });
    </script>
    
    <!-- æ•…éšœè½¬ç§»è„šæœ¬ -->
    <script>
        function handleVisJsLoadError(source) {
            console.error(`${source}åŠ è½½å¤±è´¥ï¼Œå°è¯•ä¸‹ä¸€ä¸ªæ¥æº`);
            
            if (source === 'ä¸»è¦CDN') {
                // å°è¯•å¤‡ç”¨CDN
                console.log("å°è¯•å¤‡ç”¨CDN");
                let script = document.createElement('script');
                script.src = "https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.js";
                script.crossOrigin = "anonymous";
                script.onload = function() {
                    window.visJsLoaded = true;
                    console.log("å¤‡ç”¨CDNæˆåŠŸåŠ è½½vis.jsï¼Œç‰ˆæœ¬:", vis.version || "æœªçŸ¥");
                };
                script.onerror = function() { handleVisJsLoadError('å¤‡ç”¨CDN'); };
                document.head.appendChild(script);
            } 
            else if (source === 'å¤‡ç”¨CDN') {
                // å°è¯•JsDelivr CDN
                console.log("å°è¯•JsDelivr CDN");
                let script = document.createElement('script');
                script.src = "https://cdn.jsdelivr.net/npm/vis-network/dist/vis-network.min.js";
                script.crossOrigin = "anonymous";
                script.onload = function() {
                    window.visJsLoaded = true;
                    console.log("JsDelivr CDNæˆåŠŸåŠ è½½vis.js");
                };
                script.onerror = function() {
                    console.error("æ‰€æœ‰vis.jsåŠ è½½å°è¯•å‡å¤±è´¥");
                    alert("æ— æ³•åŠ è½½å¯è§†åŒ–å›¾è°±æ‰€éœ€çš„åº“æ–‡ä»¶ã€‚è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–è”ç³»ç®¡ç†å‘˜ã€‚");
                };
                document.head.appendChild(script);
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåæ£€æŸ¥vis.jsæ˜¯å¦æˆåŠŸåŠ è½½
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(function() {
                if (!window.visJsLoaded) {
                    console.error("vis.jsåº“æœªèƒ½æˆåŠŸåŠ è½½");
                    alert("å›¾è°±å¯è§†åŒ–åº“(vis.js)åŠ è½½å¤±è´¥ï¼Œå›¾è°±åŠŸèƒ½ä¸å¯ç”¨ã€‚è¯·åˆ·æ–°é¡µé¢é‡è¯•ã€‚");
                }
            }, 2000);
        });
    </script>
    
    <style>
        /* çŸ¥è¯†å›¾è°±é¡µé¢ä¸“ç”¨æ ·å¼ */
        .graph-container {
            height: calc(100vh - 300px);
            min-height: 500px;
            max-height: 800px;
            width: 100%;
            position: relative;
            border: 1px solid #ddd;
            border-radius: 12px;
            overflow: hidden;
            margin: 20px 0;
            background-color: #f8f9fa;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
        }
        
        /* ä¿®å¤æš—è‰²æ¨¡å¼ä¸‹æ ‡é¢˜æ–‡å­—é¢œè‰²é—®é¢˜ */
        .dark-mode .control-group h3,
        .dark-mode .graph-stats h3,
        .dark-mode .learning-path h3,
        .dark-mode .form-group label,
        .dark-mode .subtitle {
            color: #ffffff !important;
        }
        
        .dark-mode p {
            color: #e0e0e0 !important;
        }
        
        .dark-mode .stat-label {
            color: #d0d0d0 !important;
        }
        
        .dark-mode .form-label {
            color: #f0f0f0 !important;
        }
        
        .graph-container:hover {
            box-shadow: 0 6px 16px rgba(0,0,0,0.12);
        }
        
        .controls-panel {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
            background-color: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }
        
        .controls-panel:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            transform: translateY(-2px);
        }
        
        .control-group {
            flex: 1;
            min-width: 200px;
        }
        
        .control-group h3 {
            font-size: 18px;
            margin-top: 0;
            margin-bottom: 12px;
            color: var(--primary-color);
            border-left: 3px solid var(--primary-color);
            padding-left: 8px;
            font-weight: 500;
        }
        
        .form-group {
            margin-bottom: 12px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 14px;
            color: #555;
        }
        
        .form-group select,
        .form-group input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            background-color: white;
            transition: all 0.2s;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
        }
        
        .form-group input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(255, 152, 0, 0.2);
            outline: none;
        }
        
        .form-group button {
            padding: 10px 18px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        
        .form-group button:hover {
            background-color: var(--primary-hover);
            transform: translateY(-1px);
            box-shadow: 0 3px 6px rgba(0,0,0,0.1);
        }
        
        .form-group button:active {
            transform: translateY(0);
            box-shadow: none;
        }
        
        /* æ›´æ–°å›¾è°±æŒ‰é’®æ ·å¼ */
        .update-graph-btn {
            padding: 12px 20px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            transition: all 0.3s ease;
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 4px 8px rgba(52, 152, 219, 0.3);
        }
        
        .update-graph-btn:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(52, 152, 219, 0.4);
        }
        
        .update-graph-btn:active {
            transform: translateY(1px);
            box-shadow: 0 2px 4px rgba(52, 152, 219, 0.3);
        }
        
        .dark-mode .update-graph-btn {
            background-color: #5a7ca2;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        
        .dark-mode .update-graph-btn:hover {
            background-color: #7094b9;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .graph-legend {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            padding: 15px 20px;
            background-color: white;
            border-radius: 12px;
            margin-top: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }
        
        .graph-legend:hover {
            box-shadow: 0 4px 10px rgba(0,0,0,0.08);
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            border-radius: 20px;
            background-color: #f5f5f5;
            transition: all 0.2s;
        }
        
        .legend-item:hover {
            background-color: #eeeeee;
            transform: translateY(-1px);
        }
        
        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .legend-text {
            font-weight: 500;
            font-size: 14px;
        }
        
        .synonym-color { background-color: #4CAF50; }
        .antonym-color { background-color: #F44336; }
        .related-color { background-color: #2196F3; }
        .topic-color { background-color: #9C27B0; }
        .root-color { background-color: #FF9800; }
        
        .graph-stats {
            margin-top: 20px;
            background-color: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }
        
        .graph-stats:hover {
            box-shadow: 0 4px 10px rgba(0,0,0,0.08);
            transform: translateY(-2px);
        }
        
        .graph-stats h3 {
            margin-top: 0;
            margin-bottom: 16px;
            font-size: 18px;
            color: #444;
            border-left: 3px solid var(--primary-color);
            padding-left: 8px;
            font-weight: 500;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }
        
        .stat-card {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            transition: all 0.2s;
            border: 1px solid #eee;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 8px rgba(0,0,0,0.08);
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--primary-color);
            margin: 8px 0;
        }
        
        .stat-label {
            font-size: 14px;
            color: #666;
        }
        
        /* åŠ è½½åŠ¨ç”»æ ·å¼ */
        .loading-overlay {
            position: fixed; /* æ”¹ä¸ºfixedç›¸å¯¹äºè§†å£å®šä½ */
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.95); /* å¢åŠ ä¸é€æ˜åº¦ */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999; /* æé«˜z-indexç¡®ä¿æ˜¾ç¤ºåœ¨æœ€é¡¶å±‚ */
            backdrop-filter: blur(5px); /* å¢åŠ æ¨¡ç³Šæ•ˆæœ */
            pointer-events: all !important; /* ç¡®ä¿æ¥æ”¶é¼ æ ‡äº‹ä»¶ */
            visibility: visible !important; /* ç¡®ä¿å¯è§æ€§ */
        }
        
        .dark-mode .loading-overlay {
            background-color: rgba(30, 30, 30, 0.95);
        }
        
        .loader {
            width: 60px;
            height: 60px;
            border: 6px solid rgba(52, 152, 219, 0.3);
            border-top: 6px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        
        .dark-mode .loader {
            border-color: rgba(82, 115, 255, 0.3);
            border-top-color: var(--primary-color);
            box-shadow: 0 0 15px rgba(109, 143, 255, 0.2);
        }
        
        .loading-text {
            font-size: 18px;
            color: #555;
            font-weight: 500;
            text-align: center;
            max-width: 80%;
            line-height: 1.5;
            animation: pulse 1.5s infinite;
        }
        
        .dark-mode .loading-text {
            color: #d0d0d0;
        }
        
        @keyframes pulse {
            0% { opacity: 0.7; }
            50% { opacity: 1; }
            100% { opacity: 0.7; }
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .learning-path {
            margin-top: 20px;
            background-color: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }
        
        .learning-path:hover {
            box-shadow: 0 4px 10px rgba(0,0,0,0.08);
            transform: translateY(-2px);
        }
        
        .learning-path h3 {
            margin-top: 0;
            margin-bottom: 16px;
            font-size: 18px;
            color: #444;
            border-left: 3px solid var(--primary-color);
            padding-left: 8px;
            font-weight: 500;
        }
        
        .path-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
        }
        
        .path-item {
            background-color: #f0f0f0;
            padding: 8px 15px;
            border-radius: 30px;
            font-size: 14px;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid #e0e0e0;
        }
        
        .path-item:hover {
            background-color: #e0e0e0;
            transform: translateY(-2px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .path-item.marked {
            background-color: #ffe0b2;
            font-weight: 500;
            border-color: #ffb74d;
        }
        
        .path-arrow {
            margin: 0 5px;
            color: #999;
            font-weight: bold;
        }
        
        .node-tooltip {
            position: absolute;
            background-color: white;
            padding: 12px 16px;
            border-radius: 8px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.15);
            z-index: 100;
            font-size: 14px;
            max-width: 300px;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.2s;
            border-left: 3px solid var(--primary-color);
        }
        
        .node-tooltip.visible {
            visibility: visible;
            opacity: 1;
        }
        
        .header-section {
            text-align: center;
            margin-bottom: 30px;
            position: relative;
            animation: fadeIn 0.6s ease-out;
        }
        
        .header-section h1 {
            font-size: 32px;
            margin-bottom: 8px;
            color: #333;
            position: relative;
            display: inline-block;
            font-weight: 600;
        }
        
        .header-section h1:after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 50%;
            width: 80px;
            height: 3px;
            background-color: var(--primary-color);
            transform: translateX(-50%);
        }
        
        .subtitle {
            color: #666;
            font-size: 16px;
            max-width: 600px;
            margin: 0 auto;
            line-height: 1.5;
        }
        
        .action-bar {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            animation: fadeIn 0.8s ease-out;
        }
        
        .back-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 18px;
            background-color: #f0f0f0;
            color: #333;
            text-decoration: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .back-btn:hover {
            background-color: #e0e0e0;
            transform: translateX(-3px);
            box-shadow: 0 3px 8px rgba(0,0,0,0.08);
        }
        
        /* æŒ‰é’®å›¾æ ‡æ ·å¼ */
        .btn-icon {
            width: 18px;
            height: 18px;
        }
        
        /* å›¾è°±åˆå§‹æç¤ºæ ·å¼ */
        .graph-initial-prompt {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: rgba(248, 249, 250, 0.95);
            z-index: 50;
            padding: 30px;
        }
        
        .prompt-content {
            text-align: center;
            padding: 40px;
            background-color: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            max-width: 80%;
            animation: fadeIn 0.5s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .prompt-content h3 {
            margin-top: 0;
            color: var(--primary-color);
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 16px;
        }
        
        .prompt-icon {
            margin: 0 0 20px;
            font-size: 60px;
        }
        
        .prompt-content p {
            color: #666;
            font-size: 16px;
            line-height: 1.6;
        }
        
        /* æš—è‰²æ¨¡å¼é€‚é… */
        .dark-mode .graph-container {
            background-color: #222;
            border-color: #444;
        }
        
        .dark-mode .controls-panel,
        .dark-mode .graph-legend,
        .dark-mode .graph-stats,
        .dark-mode .learning-path,
        .dark-mode .simple-graph-view {
            background-color: #2d2d2d;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        .dark-mode .form-group label {
            color: #ccc;
        }
        
        .dark-mode .form-group input,
        .dark-mode .form-group select {
            background-color: #333;
            border-color: #555;
            color: #eee;
        }
        
        .dark-mode .stat-card {
            background-color: #333;
            border-color: #444;
        }
        
        .dark-mode .stat-label {
            color: #bbb;
        }
        
        .dark-mode .path-list {
            background-color: #333;
        }
        
        .dark-mode .path-item {
            background-color: #444;
            border-color: #555;
            color: #eee;
        }
        
        .dark-mode .node-tooltip {
            background-color: #333;
            color: #eee;
        }
        
        .dark-mode .header-section h1 {
            color: #eee;
        }
        
        .dark-mode .subtitle {
            color: #bbb;
        }
        
        .dark-mode .back-btn {
            background-color: #444;
            color: #eee;
        }
        
        .dark-mode .prompt-content {
            background-color: #2d2d2d;
        }
        
        .dark-mode .prompt-content h3 {
            color: #6d8fff;
        }
        
        .dark-mode .prompt-content p {
            color: #bbb;
        }
        
        .dark-mode .legend-item {
            background-color: #3a3a3a;
        }
        
        .dark-mode .legend-item:hover {
            background-color: #444;
        }
        
        /* å“åº”å¼å¸ƒå±€ */
        @media (max-width: 768px) {
            .controls-panel {
                flex-direction: column;
                gap: 15px;
            }
            
            .control-group {
                width: 100%;
            }
            
            .graph-container {
                height: 400px;
            }
            
            .header-section h1 {
                font-size: 24px;
            }
            
            .prompt-content {
                padding: 25px;
                max-width: 90%;
            }
            
            .back-btn {
                padding: 8px 15px;
                font-size: 13px;
            }
            
            .action-bar {
                margin-bottom: 15px;
            }
            
            .stat-card {
                padding: 12px;
            }
            
            .stat-value {
                font-size: 24px;
            }
            
            .button-group {
                flex-direction: column;
                gap: 8px;
            }
            
            .form-group button {
                width: 100%;
            }
        }
        
        .loading-info {
            font-size: 14px;
            color: #777;
            margin-top: 15px;
            text-align: center;
            max-width: 80%;
            opacity: 0.8;
        }
        
        .dark-mode .loading-info {
            color: #aaa;
        }
        
        body.loading-active .loading-overlay {
            display: flex !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
    </style>
</head>
<body>
    <!-- ä¸»é¢˜åˆ‡æ¢æŒ‰é’® -->
    <button id="themeToggleBtn" class="theme-toggle-btn" title="åˆ‡æ¢ä¸»é¢˜">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" id="themeIcon"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
    </button>

    <!-- å…¨å±€åŠ è½½åŠ¨ç”» -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loader"></div>
        <div class="loading-text">æ­£åœ¨ç”ŸæˆçŸ¥è¯†å›¾è°±...</div>
        <div class="loading-info">è¯·ç¨å€™ï¼Œæ­£åœ¨é€šè¿‡APIè·å–å•è¯å…³ç³»æ•°æ®</div>
    </div>

    <div class="container">
        <div class="header-section">
            <h1>å•è¯çŸ¥è¯†å›¾è°±</h1>
            <p class="subtitle">è¯¥åŠŸèƒ½å°šåœ¨æµ‹è¯•ç¯èŠ‚ï¼Œæ„Ÿè°¢æ‚¨çš„ä½¿ç”¨ä¸å»ºè®®ï¼</p>
        </div>
        
        <div class="action-bar">
            <a href="/word_list" class="back-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
                è¿”å›å•è¯åˆ—è¡¨
            </a>
        </div>
        
        <div class="controls-panel">
            <div class="control-group">
                <h3>å›¾è°±ç„¦ç‚¹</h3>
                <form action="/knowledge_graph" method="get" id="graphForm">
                    <div class="form-group">
                        <label for="focusWordInput">ç„¦ç‚¹å•è¯ï¼š</label>
                        <input type="text" id="focusWordInput" name="word" placeholder="è¾“å…¥å•è¯ä½œä¸ºå›¾è°±ä¸­å¿ƒ" value="{{ request.args.get('word', '') }}">
                    </div>
                    <input type="hidden" name="type" value="all">
                    <input type="hidden" name="depth" value="2">
                    <div class="button-group">
                        <button type="button" id="updateFocusBtn" class="update-graph-btn">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="btn-icon"><path d="M23 4v6h-6"></path><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></svg>
                            æ›´æ–°å›¾è°±
                        </button>
                        {% if has_graph_data %}
                        {% endif %}
                    </div>
                </form>
            </div>
        </div>
        
        <div id="graphContainer" class="graph-container">
            <!-- åˆå§‹æç¤º -->
            <div id="graphInitialPrompt" class="graph-initial-prompt" style="display: {{ 'none' if has_graph_data else 'block' }}">
                <div class="prompt-content">
                    <div class="prompt-icon">ğŸ”</div>
                    <h3>å¼€å§‹æ¢ç´¢çŸ¥è¯†å›¾è°±</h3>
                    <p>åœ¨ä¸Šæ–¹è¾“å…¥æ¡†ä¸­è¾“å…¥ä¸€ä¸ªè‹±æ–‡å•è¯ï¼Œç„¶åç‚¹å‡»"æ›´æ–°å›¾è°±"æŒ‰é’®<br>æŸ¥çœ‹ä¸è¯¥å•è¯ç›¸å…³çš„åŒä¹‰è¯ã€åä¹‰è¯ã€ç›¸å…³è¯å’Œä¸»é¢˜è¯</p>
                </div>
            </div>
            
            <!-- å›¾è°±çŠ¶æ€ä¿¡æ¯ -->
            <div id="graphStatus" class="graph-status" style="display: none;"></div>
            
            {% if error_message %}
            <div class="error-message">
                <p>è·å–çŸ¥è¯†å›¾è°±æ—¶å‘ç”Ÿé”™è¯¯: {{ error_message }}</p>
            </div>
            {% endif %}
            
            <!-- å¤‡ç”¨çš„ç®€å•è§†å›¾è¡¨æ ¼ -->
            <div class="simple-graph-view" style="display: none;">
                <div class="simple-view-header">
                    <h3>çŸ¥è¯†å›¾è°± - ç®€æ˜“è¡¨æ ¼è§†å›¾</h3>
                    <p>è¿™é‡Œæä¾›ç®€æ˜“è¡¨æ ¼è§†å›¾å±•ç¤ºå•è¯å…³ç³»</p>
                    <button id="viewToggleBtn" class="btn btn-secondary">åˆ‡æ¢è‡³å›¾è°±è§†å›¾</button>
                </div>
                
                {% if has_graph_data and focus_word %}
                <div class="simple-view-focus">
                    <h4>ç„¦ç‚¹å•è¯: <span class="focus-word">{{ focus_word }}</span></h4>
                </div>
                
                <div class="simple-view-relations">
                    {% if grouped_relations %}
                    <div class="relation-group synonym-group">
                        <h5>åŒä¹‰è¯ <span class="relation-dot" style="background-color: {{ relation_colors.synonym }}"></span></h5>
                        <div class="relation-words">
                            {% if grouped_relations.synonym %}
                                {% for word in grouped_relations.synonym %}
                                <span class="relation-word-tag">{{ word }}</span>
                                {% endfor %}
                            {% else %}
                            <span class="empty-relation">æš‚æ— åŒä¹‰è¯æ•°æ®</span>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="relation-group antonym-group">
                        <h5>åä¹‰è¯ <span class="relation-dot" style="background-color: {{ relation_colors.antonym }}"></span></h5>
                        <div class="relation-words">
                            {% if grouped_relations.antonym %}
                                {% for word in grouped_relations.antonym %}
                                <span class="relation-word-tag">{{ word }}</span>
                                {% endfor %}
                            {% else %}
                            <span class="empty-relation">æš‚æ— åä¹‰è¯æ•°æ®</span>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="relation-group related-group">
                        <h5>ç›¸å…³è¯ <span class="relation-dot" style="background-color: {{ relation_colors.related }}"></span></h5>
                        <div class="relation-words">
                            {% if grouped_relations.related %}
                                {% for word in grouped_relations.related %}
                                <span class="relation-word-tag">{{ word }}</span>
                                {% endfor %}
                            {% else %}
                            <span class="empty-relation">æš‚æ— ç›¸å…³è¯æ•°æ®</span>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="relation-group topic-group">
                        <h5>ä¸»é¢˜è¯ <span class="relation-dot" style="background-color: {{ relation_colors.topic }}"></span></h5>
                        <div class="relation-words">
                            {% if grouped_relations.topic %}
                                {% for word in grouped_relations.topic %}
                                <span class="relation-word-tag">{{ word }}</span>
                                {% endfor %}
                            {% else %}
                            <span class="empty-relation">æš‚æ— ä¸»é¢˜è¯æ•°æ®</span>
                            {% endif %}
                        </div>
                    </div>
                    {% else %}
                    <div class="no-relations">
                        <p>æœªæ‰¾åˆ°å•è¯å…³ç³»æ•°æ®</p>
                    </div>
                    {% endif %}
                </div>
                {% else %}
                <div class="no-focus-word">
                    <p>è¯·åœ¨ä¸Šæ–¹è¾“å…¥æ¡†ä¸­è¾“å…¥ä¸€ä¸ªå•è¯ï¼Œç„¶åç‚¹å‡»"æ›´æ–°å›¾è°±"æŒ‰é’®ã€‚</p>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- èŠ‚ç‚¹ä¿¡æ¯æç¤ºæ¡† -->
        <div id="nodeTooltip" class="node-tooltip"></div>
    </div>
    
    <div class="graph-legend">
        <div class="legend-item">
            <span class="legend-color root-color"></span>
            <span class="legend-text">ä¸­å¿ƒè¯</span>
        </div>
        <div class="legend-item">
            <span class="legend-color synonym-color"></span>
            <span class="legend-text">åŒä¹‰è¯</span>
        </div>
        <div class="legend-item">
            <span class="legend-color antonym-color"></span>
            <span class="legend-text">åä¹‰è¯</span>
        </div>
        <div class="legend-item">
            <span class="legend-color related-color"></span>
            <span class="legend-text">ç›¸å…³è¯</span>
        </div>
        <div class="legend-item">
            <span class="legend-color topic-color"></span>
            <span class="legend-text">ä¸»é¢˜è¯</span>
        </div>
    </div>
    
    <div class="graph-stats">
        <h3>å›¾è°±ç»Ÿè®¡</h3>
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="statNodeCount">0</div>
                <div class="stat-label">å•è¯æ•°é‡</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statEdgeCount">0</div>
                <div class="stat-label">å…³ç³»æ•°é‡</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statClusterCount">0</div>
                <div class="stat-label">å•è¯ç°‡æ•°</div>
            </div>
        </div>
    </div>
    
    <div class="learning-path">
        <h3>æ¨èå­¦ä¹ è·¯å¾„</h3>
        <p>åŸºäºå›¾è°±åˆ†æçš„æœ€ä¼˜å­¦ä¹ é¡ºåºï¼š</p>
        <div class="path-list" id="learningPath">
            <!-- å­¦ä¹ è·¯å¾„å°†åœ¨è¿™é‡Œç”Ÿæˆ -->
        </div>
    </div>
</div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOMå·²åŠ è½½å®Œæˆ");
            
            // è·å–DOMå…ƒç´ 
            const graphContainer = document.getElementById('graphContainer');
            const simpleView = document.querySelector('.simple-graph-view');
            const focusWordInput = document.getElementById('focusWordInput');
            const viewToggleBtn = document.getElementById('viewToggleBtn');
            const loadingOverlay = document.getElementById('loadingOverlay');
            const graphInitialPrompt = document.getElementById('graphInitialPrompt');
            const debugBtn = document.getElementById('debugBtn');
            const zoomInBtn = document.getElementById('zoomInBtn');
            const zoomOutBtn = document.getElementById('zoomOutBtn');
            const centerBtn = document.getElementById('centerBtn');
            const updateFocusBtn = document.getElementById('updateFocusBtn');
            const learningPath = document.getElementById('learningPath');
            const statNodeCount = document.getElementById('statNodeCount');
            const statEdgeCount = document.getElementById('statEdgeCount');
            const statClusterCount = document.getElementById('statClusterCount');
            
            // æ£€æŸ¥å…³é”®å…ƒç´ æ˜¯å¦å­˜åœ¨
            const requiredElements = [
                { name: 'graphContainer', element: graphContainer },
                { name: 'updateFocusBtn', element: updateFocusBtn },
                { name: 'learningPath', element: learningPath }
            ];
            
            let missingElements = requiredElements.filter(item => !item.element);
            if (missingElements.length > 0) {
                console.error("å…³é”®DOMå…ƒç´ ç¼ºå¤±:", missingElements.map(item => item.name).join(', '));
                // å¯ä»¥æ˜¾ç¤ºå‹å¥½çš„é”™è¯¯ä¿¡æ¯
                if (graphContainer) {
                    graphContainer.innerHTML = `
                        <div style="padding: 20px; text-align: center; color: #F44336;">
                            <h3>é¡µé¢åŠ è½½é”™è¯¯</h3>
                            <p>æŸäº›é¡µé¢å…ƒç´ æœªèƒ½æ­£ç¡®åŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•ã€‚</p>
                            <p>ç¼ºå¤±å…ƒç´ : ${missingElements.map(item => item.name).join(', ')}</p>
                        </div>
                    `;
                }
            }
            
            console.log("DOMå…ƒç´ çŠ¶æ€:");
            console.log("- graphContainer:", graphContainer ? "æ‰¾åˆ°" : "æœªæ‰¾åˆ°");
            console.log("- simpleView:", simpleView ? "æ‰¾åˆ°" : "æœªæ‰¾åˆ°");
            console.log("- viewToggleBtn:", viewToggleBtn ? "æ‰¾åˆ°" : "æœªæ‰¾åˆ°");
            console.log("- learningPath:", learningPath ? "æ‰¾åˆ°" : "æœªæ‰¾åˆ°");
            console.log("- statNodeCount:", statNodeCount ? "æ‰¾åˆ°" : "æœªæ‰¾åˆ°");
            
            // å…¨å±€å˜é‡
            let network = null;
            let isSimpleViewMode = false; // é»˜è®¤ä¸ºå›¾è°±è§†å›¾
            
            // ç«‹å³éšè—åŠ è½½åŠ¨ç”»
            if (loadingOverlay) loadingOverlay.style.display = 'none';
            
            // è§†å›¾åˆ‡æ¢æŒ‰é’®äº‹ä»¶ç»‘å®š
            if (viewToggleBtn) {
                console.log("ç»‘å®šè§†å›¾åˆ‡æ¢æŒ‰é’®äº‹ä»¶");
                
                viewToggleBtn.onclick = function() {
                    console.log("è§†å›¾åˆ‡æ¢æŒ‰é’®è¢«ç‚¹å‡»");
                    
                    // ç¡®ä¿DOMå…ƒç´ å­˜åœ¨
                    if (!simpleView || !graphContainer) {
                        console.error("è§†å›¾åˆ‡æ¢é”™è¯¯: æ‰¾ä¸åˆ°å¿…è¦çš„DOMå…ƒç´ ");
                        alert("è§†å›¾åˆ‡æ¢å¤±è´¥: é¡µé¢å…ƒç´ ä¸å®Œæ•´");
                        return;
                    }
                    
                    if (isSimpleViewMode) {
                        // ä»ç®€å•è§†å›¾åˆ‡æ¢åˆ°å›¾è°±è§†å›¾
                        console.log("åˆ‡æ¢åˆ°å›¾è°±è§†å›¾");
                        simpleView.style.display = 'none';
                        graphContainer.style.display = 'block';
                        viewToggleBtn.textContent = 'åˆ‡æ¢åˆ°è¡¨æ ¼è§†å›¾';
                        
                        // å¦‚æœç½‘ç»œå›¾å°šæœªåˆ›å»ºä¸”æœ‰å›¾è°±æ•°æ®å¯ç”¨
                        if (!network && {{ has_graph_data|tojson }}) {
                            {% if graph_data_json is defined %}
                            const graphData = {{ graph_data_json|safe }};
                            createNetwork(graphData);
                            {% else %}
                            console.warn("æ— æ³•åˆ›å»ºç½‘ç»œå›¾: å›¾è°±æ•°æ®æœªå®šä¹‰");
                            {% endif %}
                        }
                    } else {
                        // ä»å›¾è°±è§†å›¾åˆ‡æ¢åˆ°ç®€å•è§†å›¾
                        console.log("åˆ‡æ¢åˆ°è¡¨æ ¼è§†å›¾");
                        simpleView.style.display = 'block';
                        graphContainer.style.display = 'none';
                        viewToggleBtn.textContent = 'åˆ‡æ¢åˆ°å›¾è°±è§†å›¾';
                    }
                    
                    isSimpleViewMode = !isSimpleViewMode;
                };
            } else {
                console.warn("è§†å›¾åˆ‡æ¢æŒ‰é’®æœªæ‰¾åˆ°ï¼Œæ— æ³•ç»‘å®šäº‹ä»¶");
            }
            
            // è°ƒè¯•æŒ‰é’®äº‹ä»¶
            if (debugBtn) {
                debugBtn.addEventListener('click', function() {
                    {% if has_graph_data %}
                    try {
                        {% if graph_data_json is defined %}
                        const data = {{ graph_data_json|safe }};
                        console.log("å®Œæ•´å›¾è°±æ•°æ®:", data);
                        
                        // æ˜¾ç¤ºæ›´è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯
                        let debugInfo = `å›¾è°±æ•°æ®çŠ¶æ€:\n`;
                        debugInfo += `- èŠ‚ç‚¹æ•°: ${data.nodes.length}\n`;
                        debugInfo += `- è¾¹æ•°: ${data.edges.length}\n\n`;
                        
                        // æ£€æŸ¥vis.jsåŠ è½½çŠ¶æ€
                        debugInfo += `å¯è§†åŒ–åº“(vis.js)çŠ¶æ€:\n`;
                        debugInfo += `- å·²åŠ è½½: ${window.visJsLoaded ? "æ˜¯" : "å¦"}\n`;
                        if (window.vis) {
                            debugInfo += `- ç‰ˆæœ¬: ${window.vis.version || "æœªçŸ¥"}\n`;
                        } else {
                            debugInfo += `- viså¯¹è±¡ä¸å­˜åœ¨\n`;
                        }
                        
                        // æ£€æŸ¥å›¾è°±å®¹å™¨
                        const container = document.getElementById('graphContainer');
                        debugInfo += `\nå›¾è°±å®¹å™¨çŠ¶æ€:\n`;
                        debugInfo += `- å­˜åœ¨: ${container ? "æ˜¯" : "å¦"}\n`;
                        if (container) {
                            debugInfo += `- å¯è§æ€§: ${container.style.display}\n`;
                            debugInfo += `- å°ºå¯¸: ${container.clientWidth}x${container.clientHeight}\n`;
                        }
                        
                        // æ£€æŸ¥ç½‘ç»œå›¾å®ä¾‹
                        debugInfo += `\nç½‘ç»œå›¾å®ä¾‹çŠ¶æ€:\n`;
                        debugInfo += `- å­˜åœ¨: ${window.network ? "æ˜¯" : "å¦"}\n`;
                        
                        // æ˜¾ç¤ºèŠ‚ç‚¹ä¿¡æ¯
                        debugInfo += `\nèŠ‚ç‚¹ä¿¡æ¯ç¤ºä¾‹ (æœ€å¤š5ä¸ª):\n`;
                        for (let i=0; i < Math.min(5, data.nodes.length); i++) {
                            const node = data.nodes[i];
                            debugInfo += `${i+1}. ${node.id} (${node.group || "æ— ç»„"}) - é¢œè‰²: ${node.color}\n`;
                        }
                        
                        alert(debugInfo);
                        
                        // åœ¨æ§åˆ¶å°è¾“å‡ºå®Œæ•´æ•°æ®
                        console.log("èŠ‚ç‚¹æ•°æ®:", data.nodes);
                        console.log("è¾¹æ•°æ®:", data.edges);
                        
                        // é¢å¤–å°è¯•é‡æ–°åˆå§‹åŒ–ç½‘ç»œå›¾
                        const graphContainer = document.getElementById('graphContainer');
                        if (!window.network && window.visJsLoaded && graphContainer) {
                            console.log("å°è¯•é‡æ–°åˆå§‹åŒ–ç½‘ç»œå›¾...");
                            try {
                                createNetwork(data);
                                alert("å·²å°è¯•é‡æ–°åˆå§‹åŒ–ç½‘ç»œå›¾ï¼Œè¯·æ£€æŸ¥æ˜¯å¦æˆåŠŸæ˜¾ç¤ºã€‚");
                            } catch (e) {
                                alert(`é‡æ–°åˆå§‹åŒ–ç½‘ç»œå›¾å¤±è´¥: ${e.message}`);
                            }
                        }
                        {% else %}
                        alert("å›¾è°±æ•°æ®æœªæ­£ç¡®åŠ è½½");
                        {% endif %}
                    } catch (e) {
                        alert(`è§£æå›¾è°±æ•°æ®å‡ºé”™: ${e.message}`);
                        console.error("è§£æå›¾è°±æ•°æ®å‡ºé”™:", e);
                    }
                    {% else %}
                    alert("å½“å‰é¡µé¢æ²¡æœ‰å›¾è°±æ•°æ®");
                    {% endif %}
                });
            }
            
            // æ£€æŸ¥æ˜¯å¦æœ‰æœåŠ¡å™¨ç›´æ¥ä¼ é€’çš„å›¾è°±æ•°æ®
            {% if has_graph_data %}
                console.log("æœåŠ¡å™¨ç›´æ¥ä¼ é€’çš„å›¾è°±æ•°æ®å¯ç”¨");
                try {
                    {% if graph_data_json is defined %}
                    const graphData = {{ graph_data_json|safe }};
                    console.log("æ¥æ”¶åˆ°çš„å›¾è°±æ•°æ®:", graphData);
                    
                    // ç¡®ä¿éšè—ç®€å•è§†å›¾ï¼Œæ˜¾ç¤ºå›¾è°±è§†å›¾
                    if (simpleView) {
                        simpleView.style.display = 'none';
                    }
                    if (graphContainer) {
                        graphContainer.style.display = 'block';
                    }
                    isSimpleViewMode = false;
                    
                    // æ›´æ–°è§†å›¾åˆ‡æ¢æŒ‰é’®æ–‡æœ¬
                    if (viewToggleBtn) {
                        viewToggleBtn.textContent = 'åˆ‡æ¢åˆ°è¡¨æ ¼è§†å›¾';
                    }
                    
                    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                    updateGraphStats(graphData);
                    
                    // ç”Ÿæˆå­¦ä¹ è·¯å¾„
                    generateLearningPath(graphData);
                    
                    // ç›´æ¥è°ƒç”¨å›¾è°±æ¸²æŸ“å‡½æ•°
                    setTimeout(function() {
                        console.log("è‡ªåŠ¨è°ƒç”¨createNetworkå‡½æ•°");
                        if (window.visJsLoaded) {
                            createNetwork(graphData);
                            
                            // ä¿å­˜å›¾è°±æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨
                            const focusWord = document.getElementById('focusWordInput').value.trim();
                            if (focusWord) {
                                saveGraphDataToLocalStorage(focusWord, graphData);
                            }
                        } else {
                            console.error("æ— æ³•åˆ›å»ºç½‘ç»œå›¾: vis.jsåº“æœªåŠ è½½");
                            alert("æ— æ³•åˆ›å»ºå›¾è°±: å¯è§†åŒ–åº“æœªæ­£ç¡®åŠ è½½ã€‚è¯·åˆ·æ–°é¡µé¢é‡è¯•ã€‚");
                        }
                    }, 500); // å»¶è¿Ÿä¸€ç‚¹æ—¶é—´ï¼Œç¡®ä¿DOMå·²å®Œå…¨åŠ è½½
                    
                    // éšè—åˆå§‹æç¤º
                    if (graphInitialPrompt) {
                        graphInitialPrompt.style.display = 'none';
                    }
                    
                    // æ·»åŠ å›¾è°±æ§åˆ¶æŒ‰é’®äº‹ä»¶
                    if (zoomInBtn) {
                        zoomInBtn.addEventListener('click', function() {
                            if (network) {
                                network.zoom(1.2); // æ”¾å¤§1.2å€
                            }
                        });
                    }
                    
                    if (zoomOutBtn) {
                        zoomOutBtn.addEventListener('click', function() {
                            if (network) {
                                network.zoom(0.8); // ç¼©å°åˆ°0.8å€
                            }
                        });
                    }
                    
                    if (centerBtn) {
                        centerBtn.addEventListener('click', function() {
                            if (network) {
                                network.fit({
                                    animation: {
                                        duration: 800,
                                        easingFunction: 'easeInOutQuad'
                                    }
                                });
                            }
                        });
                    }
                    
                    // æ¢å¤èŠ‚ç‚¹äº¤äº’åŠŸèƒ½
                    try {
                        // æ‚¬åœæç¤º
                        network.on('hoverNode', function(params) {
                            try {
                                const nodeId = params.node;
                                const node = visData.nodes.get(nodeId);
                                
                                // åœ¨æ§åˆ¶å°æ˜¾ç¤ºèŠ‚ç‚¹ä¿¡æ¯ï¼Œç”¨äºè°ƒè¯•
                                console.log("æ‚¬åœèŠ‚ç‚¹:", node);
                                
                                // æ˜¾ç¤ºèŠ‚ç‚¹ä¿¡æ¯
                                const tooltip = document.getElementById('nodeTooltip');
                                if (tooltip) {
                                    tooltip.innerHTML = `
                                        <div style="font-weight:600; color:${node.color}; font-size:16px;">
                                            ${node.label}
                                        </div>
                                        <div>${node.group || 'æœªåˆ†ç±»'}</div>`;
                                    
                                    // å®šä½æç¤ºæ¡†
                                    const pointer = params.event.center;
                                    tooltip.style.left = `${pointer.x + 10}px`;
                                    tooltip.style.top = `${pointer.y + 10}px`;
                                    tooltip.style.visibility = 'visible';
                                    tooltip.style.opacity = '1';
                                }
                            } catch (e) {
                                console.error("æ˜¾ç¤ºèŠ‚ç‚¹æç¤ºæ—¶å‡ºé”™:", e);
                            }
                        });
                        
                        // ç§»å‡ºèŠ‚ç‚¹æ—¶éšè—æç¤º
                        network.on('blurNode', function() {
                            const tooltip = document.getElementById('nodeTooltip');
                            if (tooltip) {
                                tooltip.style.visibility = 'hidden';
                                tooltip.style.opacity = '0';
                            }
                        });
                        
                        // ç‚¹å‡»èŠ‚ç‚¹åŠŸèƒ½
                        network.on('click', function(params) {
                            if (params.nodes && params.nodes.length > 0) {
                                const nodeId = params.nodes[0];
                                const focusWordInput = document.getElementById('focusWordInput');
                                if (focusWordInput && nodeId !== focusWordInput.value) {
                                    focusWordInput.value = nodeId;
                                    console.log("é€‰æ‹©äº†æ–°çš„ç„¦ç‚¹å•è¯:", nodeId);
                                }
                            }
                        });
                    } catch (e) {
                        console.error("æ·»åŠ äº‹ä»¶ç›‘å¬å™¨æ—¶å‡ºé”™:", e);
                    }
                    
                    // ä¿å­˜å›¾è°±æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨
                    const focusWord = document.getElementById('focusWordInput').value.trim();
                    if (focusWord) {
                        saveGraphDataToLocalStorage(focusWord, graphData);
                    }
                    {% else %}
                    console.log("æ²¡æœ‰æ¥æ”¶åˆ°å›¾è°±æ•°æ®");
                    {% endif %}
                } catch (error) {
                    console.error("å›¾è°±æ•°æ®å¤„ç†å‡ºé”™:", error);
                    alert("å›¾è°±æ•°æ®å¤„ç†å‡ºé”™: " + error.message);
                }
            {% else %}
                console.log("æ²¡æœ‰æœåŠ¡å™¨ä¼ é€’çš„å›¾è°±æ•°æ®ï¼Œå°è¯•ä»æœ¬åœ°å­˜å‚¨åŠ è½½");
                // å°è¯•ä»æœ¬åœ°å­˜å‚¨åŠ è½½ä¸Šæ¬¡çš„å›¾è°±æ•°æ®
                const loadedFromStorage = loadGraphDataFromLocalStorage();
                
                // å¦‚æœæ²¡æœ‰ä»æœ¬åœ°å­˜å‚¨åŠ è½½åˆ°æ•°æ®ï¼Œåˆ™æ˜¾ç¤ºåˆå§‹æç¤º
                if (!loadedFromStorage && graphInitialPrompt) {
                    graphInitialPrompt.style.display = 'block';
                }
            {% endif %}
            
            console.log("äº‹ä»¶ç»‘å®šå®Œæˆ");
            
            // åˆå§‹çŠ¶æ€éšè—åŠ è½½åŠ¨ç”»
            showLoading(false);
            
            // ä½¿ç”¨æ›´å®‰å…¨çš„æ–¹å¼ç»‘å®šäº‹ä»¶
            function safeBindEvent(element, event, handler) {
                if (element) {
                    try {
                        element.addEventListener(event, handler);
                        return true;
                    } catch (e) {
                        console.error(`ä¸ºå…ƒç´ ç»‘å®š${event}äº‹ä»¶å¤±è´¥:`, e);
                        return false;
                    }
                }
                return false;
            }
            
            // ç»‘å®šæ›´æ–°æŒ‰é’®äº‹ä»¶
            if (updateFocusBtn) {
                safeBindEvent(updateFocusBtn, 'click', function(e) {
                    e.preventDefault(); // é˜²æ­¢è¡¨å•ç›´æ¥æäº¤
                    console.log("æ›´æ–°æŒ‰é’®è¢«ç‚¹å‡»");
                    
                    // æ˜¾ç¤ºç¡®è®¤å¼¹çª—ï¼Œæç¤ºç”¨æˆ·æ“ä½œå°†æ¸…ç©ºå½“å‰å›¾è°±å¹¶æ¶ˆè€—token
                    if (confirm("è¿™å°†æ¸…ç©ºç°åœ¨çš„çŸ¥è¯†å›¾è°±ï¼Œå¹¶æ¶ˆè€—tokenã€‚ç¡®å®šè¦ç»§ç»­å—ï¼Ÿ")) {
                        renderKnowledgeGraph();
                    }
                });
                console.log("å·²ç»‘å®šæ›´æ–°æŒ‰é’®äº‹ä»¶");
            } else {
                console.error("æœªæ‰¾åˆ°æ›´æ–°æŒ‰é’®(#updateFocusBtn)");
            }
            
            // ç»‘å®šå›è½¦é”®äº‹ä»¶
            if (focusWordInput) {
                safeBindEvent(focusWordInput, 'keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault(); // é˜²æ­¢è¡¨å•ç›´æ¥æäº¤
                        console.log("æŒ‰ä¸‹å›è½¦é”®");
                        
                        // æ˜¾ç¤ºç¡®è®¤å¼¹çª—ï¼Œæç¤ºç”¨æˆ·æ“ä½œå°†æ¸…ç©ºå½“å‰å›¾è°±å¹¶æ¶ˆè€—token
                        if (confirm("è¿™å°†æ¸…ç©ºç°åœ¨çš„çŸ¥è¯†å›¾è°±ï¼Œå¹¶æ¶ˆè€—tokenã€‚ç¡®å®šè¦ç»§ç»­å—ï¼Ÿ")) {
                            renderKnowledgeGraph();
                        }
                    }
                });
                console.log("å·²ç»‘å®šè¾“å…¥æ¡†å›è½¦äº‹ä»¶");
            }

            // ä¸»é¢˜åˆ‡æ¢ç›¸å…³çš„è„šæœ¬
            const themeToggleBtn = document.getElementById('themeToggleBtn');
            const themeIcon = document.getElementById('themeIcon');
            
            // æ£€æŸ¥ç”¨æˆ·åå¥½
            const isDarkMode = localStorage.getItem('darkMode') === 'true';
            
            // åº”ç”¨åˆå§‹ä¸»é¢˜
            if (isDarkMode) {
                document.documentElement.classList.add('dark-mode');
                updateThemeIcon(true);
            }
            
            // ä¸»é¢˜åˆ‡æ¢äº‹ä»¶
            themeToggleBtn.addEventListener('click', function() {
                const isDarkMode = document.documentElement.classList.toggle('dark-mode');
                localStorage.setItem('darkMode', isDarkMode);
                updateThemeIcon(isDarkMode);
            });
            
            // æ›´æ–°å›¾æ ‡æ˜¾ç¤º
            function updateThemeIcon(isDarkMode) {
                if (isDarkMode) {
                    // æ˜¾ç¤ºå¤ªé˜³å›¾æ ‡ï¼ˆäº®è‰²æ¨¡å¼å›¾æ ‡ï¼‰
                    themeIcon.innerHTML = '<circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>';
                } else {
                    // æ˜¾ç¤ºæœˆäº®å›¾æ ‡ï¼ˆæš—è‰²æ¨¡å¼å›¾æ ‡ï¼‰
                    themeIcon.innerHTML = '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>';
                }
            }
        });

        // å…¨å±€å‡½æ•°ï¼Œä½¿å…¶å¯ä»¥è¢«å†…è”onclickè°ƒç”¨
        function renderKnowledgeGraph() {
            console.log("æ¸²æŸ“çŸ¥è¯†å›¾è°±å‡½æ•°è¢«è°ƒç”¨");
            
            // è·å–å‚æ•°
            const focusWordInput = document.getElementById('focusWordInput');
            if (!focusWordInput) {
                console.error("æ‰¾ä¸åˆ°ç„¦ç‚¹å•è¯è¾“å…¥æ¡†");
                alert("é¡µé¢å…ƒç´ ç¼ºå¤±ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•");
                return;
            }
            
            const loadingOverlay = document.getElementById('loadingOverlay');
            const graphInitialPrompt = document.getElementById('graphInitialPrompt');
            const graphContainer = document.getElementById('graphContainer');
            
            const focusWord = focusWordInput.value.trim();
            console.log("ç„¦ç‚¹å•è¯:", focusWord);
            
            // éªŒè¯æ˜¯å¦è¾“å…¥äº†å•è¯
            if (!focusWord) {
                alert("è¯·å…ˆåœ¨è¾“å…¥æ¡†ä¸­è¾“å…¥ä¸€ä¸ªå•è¯ï¼Œç„¶åå†ç‚¹å‡»æ›´æ–°å›¾è°±");
                return;
            }
            
            // ç¬¬1æ­¥ï¼šéšè—åˆå§‹æç¤ºï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
            if (graphInitialPrompt) {
                graphInitialPrompt.style.display = 'none';
            }
            
            // ç¬¬2æ­¥ï¼šéšè—ç°æœ‰ç½‘ç»œå›¾ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if (window.network) {
                console.log("å­˜åœ¨æ—§å›¾è°±ï¼Œå‡†å¤‡åœ¨è¯·æ±‚æˆåŠŸåé”€æ¯");
                
                // æ ‡è®°ä¸ºéšè—ï¼Œä½†ä¸ç«‹å³é”€æ¯ï¼Œç­‰æ–°æ•°æ®åˆ°æ¥åå†é”€æ¯
                try {
                    const networkCanvas = graphContainer.querySelector('canvas');
                    if (networkCanvas) {
                        networkCanvas.style.opacity = '0.1'; // åŠé€æ˜æ˜¾ç¤º
                    }
                } catch (e) {
                    console.error("è®¾ç½®ç½‘ç»œå›¾é€æ˜åº¦æ—¶å‡ºé”™:", e);
                }
            }
            
            // ç¬¬3æ­¥ï¼šæ˜¾ç¤ºåŠ è½½åŠ¨ç”»
            if (loadingOverlay) {
                console.log("æ˜¾ç¤ºåŠ è½½åŠ¨ç”»");
                
                // å¼ºåˆ¶åŠ è½½åŠ¨ç”»æ˜¾ç¤º
                document.body.classList.add('loading-active');
                loadingOverlay.style.display = 'flex';
                
                // åœ¨é¡µé¢ä¸Šæ˜¾å¼è®¾ç½®æ ·å¼ï¼Œé˜²æ­¢CSSè¢«è¦†ç›–
                Object.assign(loadingOverlay.style, {
                    position: 'fixed',
                    top: '0',
                    left: '0',
                    right: '0',
                    bottom: '0',
                    display: 'flex',
                    zIndex: '9999',
                    backgroundColor: 'rgba(255, 255, 255, 0.95)',
                    visibility: 'visible',
                    opacity: '1'
                });
                
                // ç¦ç”¨å®¹å™¨äº¤äº’
                if (graphContainer) {
                    graphContainer.style.pointerEvents = 'none';
                }
            } else {
                console.error("æ‰¾ä¸åˆ°åŠ è½½åŠ¨ç”»å…ƒç´ ");
            }
            
            // æ›´æ–°åŠ è½½æç¤ºæ–‡å­—
            const loadingText = document.querySelector('.loading-text');
            if (loadingText) {
                loadingText.textContent = "æ­£åœ¨ç”ŸæˆçŸ¥è¯†å›¾è°±...";
            }
            
            // ç½‘ç»œè¯·æ±‚å‰å…ˆæ£€æŸ¥ç½‘ç»œè¿æ¥
            if (!navigator.onLine) {
                console.error("ç½‘ç»œè¿æ¥å·²æ–­å¼€");
                hideLoadingAnimation();
                alert("ç½‘ç»œè¿æ¥å·²æ–­å¼€ï¼Œæ— æ³•ç”ŸæˆçŸ¥è¯†å›¾è°±ã€‚è¯·æ£€æŸ¥æ‚¨çš„ç½‘ç»œè¿æ¥åé‡è¯•ã€‚");
                return;
            }
            
            // æ„å»ºè¯·æ±‚URL
            let apiUrl = '/api/graph_data';
            const params = new URLSearchParams();
            params.append('word', focusWord);
            
            console.log("å‘é€è¯·æ±‚:", apiUrl + '?' + params.toString());
            
            // ä½¿ç”¨è¶…æ—¶å¤„ç†
            const timeoutPromise = new Promise((_, reject) => {
                setTimeout(() => reject(new Error('è¯·æ±‚è¶…æ—¶ï¼Œå¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜æˆ–æœåŠ¡å™¨å“åº”æ…¢')), 20000);
            });
            
            // æ·»åŠ ç½‘ç»œçŠ¶æ€ç›‘å¬
            const networkStateHandler = function() {
                if (!navigator.onLine) {
                    console.error("ç½‘ç»œè¿æ¥å·²æ–­å¼€");
                    hideLoadingAnimation();
                    alert("ç½‘ç»œè¿æ¥å·²æ–­å¼€ï¼Œè¯·æ±‚å·²ç»ˆæ­¢ã€‚è¯·æ£€æŸ¥æ‚¨çš„ç½‘ç»œè¿æ¥åé‡è¯•ã€‚");
                    window.removeEventListener('offline', networkStateHandler);
                }
            };
            
            // ç›‘å¬ç¦»çº¿äº‹ä»¶
            window.addEventListener('offline', networkStateHandler);
            
            // ç¬¬4æ­¥ï¼šå‘é€è¯·æ±‚è·å–æ–°çš„å›¾è°±æ•°æ®
            console.log("å¼€å§‹è¯·æ±‚æ–°çš„å›¾è°±æ•°æ®");
            Promise.race([
                fetch(apiUrl + '?' + params.toString()),
                timeoutPromise
            ])
                .then(response => {
                    console.log("æ”¶åˆ°å“åº”:", response.status);
                    window.removeEventListener('offline', networkStateHandler);
                    
                    if (!response.ok) {
                        throw new Error(`æœåŠ¡å™¨å“åº”é”™è¯¯(${response.status})ï¼š${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log("æˆåŠŸè·å–æ–°å›¾è°±æ•°æ®");
                    
                    // æ£€æŸ¥è¿”å›çš„æ•°æ®æ˜¯å¦æœ‰æ•ˆ
                    if (!data || (!data.nodes && !data.edges)) {
                        throw new Error('æœåŠ¡å™¨è¿”å›çš„å›¾è°±æ•°æ®æ ¼å¼æ— æ•ˆ');
                    }
                    
                    if (data.nodes.length === 0) {
                        throw new Error('æœªæ‰¾åˆ°ç›¸å…³å•è¯å…³ç³»æ•°æ®ï¼Œè¯·å°è¯•å…¶ä»–å•è¯');
                    }
                    
                    console.log("æ•°æ®è§£ææˆåŠŸï¼ŒèŠ‚ç‚¹æ•°:", data.nodes.length);
                    
                    // ç¬¬5æ­¥ï¼šåˆ é™¤åŸæœ‰å›¾è°±
                    if (window.network) {
                        console.log("é”€æ¯åŸæœ‰å›¾è°±");
                        try {
                            window.network.destroy();
                            window.network = null;
                        } catch (e) {
                            console.error("é”€æ¯åŸæœ‰å›¾è°±å‡ºé”™:", e);
                        }
                    }
                    
                    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                    updateGraphStats(data);
                    
                    // ç”Ÿæˆå­¦ä¹ è·¯å¾„
                    generateLearningPath(data);
                    
                    // ç¬¬6æ­¥ï¼šæ¸²æŸ“æ–°å›¾è°±
                    console.log("å¼€å§‹æ¸²æŸ“æ–°å›¾è°±");
                    createNetwork(data);
                    
                    // ä¿å­˜å›¾è°±æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨
                    saveGraphDataToLocalStorage(focusWord, data);
                    
                    // ç¬¬7æ­¥ï¼šéšè—åŠ è½½åŠ¨ç”»
                    hideLoadingAnimation();
                })
                .catch(error => {
                    console.error('è·å–å›¾è°±æ•°æ®å‡ºé”™:', error);
                    
                    // éšè—åŠ è½½åŠ¨ç”»
                    hideLoadingAnimation();
                    
                    // è¿˜åŸåŸå›¾è°±æ˜¾ç¤º
                    if (window.network) {
                        const networkCanvas = graphContainer.querySelector('canvas');
                        if (networkCanvas) {
                            networkCanvas.style.opacity = '1';
                        }
                    }
                    
                    window.removeEventListener('offline', networkStateHandler);
                    
                    // æ˜¾ç¤ºå‹å¥½çš„é”™è¯¯ä¿¡æ¯
                    let errorMessage = 'è·å–å›¾è°±æ•°æ®å¤±è´¥ï¼š';
                    
                    if (error.message.includes('è¯·æ±‚è¶…æ—¶')) {
                        errorMessage += 'è¯·æ±‚è¶…æ—¶ï¼Œè¯·æ£€æŸ¥æ‚¨çš„ç½‘ç»œè¿æ¥å¹¶é‡è¯•ã€‚';
                    } else if (error.message.includes('Failed to fetch') || error.name === 'TypeError') {
                        errorMessage += 'ç½‘ç»œè¿æ¥é”™è¯¯ï¼Œè¯·ç¡®ä¿æ‚¨å·²è¿æ¥åˆ°äº’è”ç½‘ã€‚';
                    } else if (error.message.includes('æœåŠ¡å™¨å“åº”é”™è¯¯')) {
                        errorMessage += error.message;
                    } else if (error.message.includes('æœªæ‰¾åˆ°ç›¸å…³å•è¯å…³ç³»æ•°æ®')) {
                        errorMessage += error.message;
                    } else {
                        errorMessage += error.message || 'æœªçŸ¥é”™è¯¯ï¼Œè¯·é‡è¯•ã€‚';
                    }
                    
                    alert(errorMessage);
                    
                    // å¦‚æœæ²¡æœ‰å›¾è°±æ˜¾ç¤ºï¼Œåˆ™æ˜¾ç¤ºåˆå§‹æç¤º
                    if (!window.network && graphInitialPrompt) {
                        graphInitialPrompt.style.display = 'block';
                    }
                });
            
            // è¾…åŠ©å‡½æ•°ï¼šéšè—åŠ è½½åŠ¨ç”»
            function hideLoadingAnimation() {
                if (loadingOverlay) {
                    // ç§»é™¤å¼ºåˆ¶åŠ è½½çŠ¶æ€
                    document.body.classList.remove('loading-active');
                    loadingOverlay.style.display = 'none';
                    
                    // æ¢å¤å®¹å™¨äº¤äº’
                    if (graphContainer) {
                        graphContainer.style.pointerEvents = 'auto';
                    }
                }
            }
        }

        // ä¿å­˜å›¾è°±æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨
        function saveGraphDataToLocalStorage(word, data) {
            try {
                localStorage.setItem('knowledgeGraphWord', word);
                localStorage.setItem('knowledgeGraphData', JSON.stringify(data));
                console.log("å›¾è°±æ•°æ®å·²ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨");
            } catch (e) {
                console.error("ä¿å­˜å›¾è°±æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨æ—¶å‡ºé”™:", e);
            }
        }

        // ä»æœ¬åœ°å­˜å‚¨åŠ è½½å›¾è°±æ•°æ®
        function loadGraphDataFromLocalStorage() {
            try {
                // ä¼˜å…ˆæ£€æŸ¥ç½‘ç»œè¿æ¥çŠ¶æ€
                if (!navigator.onLine) {
                    console.log("ç½‘ç»œå·²æ–­å¼€ï¼Œä¸ä»æœ¬åœ°å­˜å‚¨åŠ è½½æ•°æ®");
                    return false;
                }
                
                const word = localStorage.getItem('knowledgeGraphWord');
                const dataStr = localStorage.getItem('knowledgeGraphData');
                
                if (word && dataStr) {
                    console.log("ä»æœ¬åœ°å­˜å‚¨åŠ è½½å›¾è°±æ•°æ®:", word);
                    const data = JSON.parse(dataStr);
                    
                    // å¡«å……ç„¦ç‚¹å•è¯è¾“å…¥æ¡†
                    const focusWordInput = document.getElementById('focusWordInput');
                    if (focusWordInput) {
                        focusWordInput.value = word;
                    }
                    
                    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                    updateGraphStats(data);
                    
                    // ç”Ÿæˆå­¦ä¹ è·¯å¾„
                    generateLearningPath(data);
                    
                    // æ¸²æŸ“ç½‘ç»œå›¾
                    createNetwork(data);
                    
                    // éšè—åˆå§‹æç¤º
                    const graphInitialPrompt = document.getElementById('graphInitialPrompt');
                    if (graphInitialPrompt) {
                        graphInitialPrompt.style.display = 'none';
                    }
                    
                    return true;
                }
            } catch (e) {
                console.error("ä»æœ¬åœ°å­˜å‚¨åŠ è½½å›¾è°±æ•°æ®æ—¶å‡ºé”™:", e);
            }
            return false;
        }

        // åˆ›å»ºç½‘ç»œå›¾
        function createNetwork(data) {
            console.log("å¼€å§‹åˆ›å»ºç½‘ç»œå›¾ï¼Œæ•°æ®:", data);
            
            // æ£€æŸ¥ç½‘ç»œè¿æ¥
            if (!navigator.onLine) {
                console.error("ç½‘ç»œå·²æ–­å¼€ï¼Œä¸åˆ›å»ºç½‘ç»œå›¾");
                alert("ç½‘ç»œè¿æ¥å·²æ–­å¼€ï¼Œæ— æ³•åˆ›å»ºçŸ¥è¯†å›¾è°±ã€‚è¯·æ£€æŸ¥æ‚¨çš„ç½‘ç»œè¿æ¥åé‡è¯•ã€‚");
                
                // æ˜¾ç¤ºåˆå§‹æç¤º
                const graphInitialPrompt = document.getElementById('graphInitialPrompt');
                if (graphInitialPrompt) {
                    graphInitialPrompt.style.display = 'block';
                }
                return;
            }
            
            // æ£€æŸ¥å›¾è°±æ•°æ®æœ‰æ•ˆæ€§
            if (!data || !data.nodes || !data.edges || data.nodes.length === 0) {
                console.error("å›¾è°±æ•°æ®æ— æ•ˆï¼Œä¸åˆ›å»ºç½‘ç»œå›¾");
                alert("æ— æ³•åˆ›å»ºçŸ¥è¯†å›¾è°±ï¼šæ•°æ®æ— æ•ˆæˆ–ä¸å®Œæ•´");
                return;
            }
            
            // æ£€æŸ¥vis.jsæ˜¯å¦å·²åŠ è½½
            if (typeof vis === 'undefined') {
                console.error("æ— æ³•åˆ›å»ºç½‘ç»œå›¾: vis.jsåº“æœªåŠ è½½ï¼Œç­‰å¾…åŠ è½½å®Œæˆåé‡è¯•");
                
                // ç­‰å¾…vis.jsåŠ è½½å®Œæˆåé‡è¯•
                setTimeout(function() {
                    if (typeof vis !== 'undefined') {
                        console.log("vis.jså·²åŠ è½½ï¼Œé‡æ–°å°è¯•åˆ›å»ºç½‘ç»œå›¾");
                        createNetwork(data);
                    } else {
                        alert("æ— æ³•åˆ›å»ºå›¾è°±: å¯è§†åŒ–åº“æœªèƒ½åŠ è½½ã€‚è¯·åˆ·æ–°é¡µé¢é‡è¯•ã€‚");
                    }
                }, 2000);
                return;
            }
            
            const graphStatus = document.getElementById('graphStatus');
            const graphContainer = document.getElementById('graphContainer');
            
            if (!graphContainer) {
                console.error("æ‰¾ä¸åˆ°å›¾è°±å®¹å™¨å…ƒç´ !");
                return;
            }
            
            if (graphStatus) {
                graphStatus.textContent = "æ­£åœ¨åˆå§‹åŒ–å›¾è°±...";
                graphStatus.style.display = "block";
            }
            
            try {
                // ç¡®ä¿å›¾è°±å®¹å™¨å¯è§å¹¶æœ‰è¶³å¤Ÿçš„å°ºå¯¸
                graphContainer.style.display = 'block';
                if (graphContainer.clientHeight < 100) {
                    console.log("å›¾è°±å®¹å™¨é«˜åº¦ä¸è¶³ï¼Œè®¾ç½®æœ€å°é«˜åº¦");
                    graphContainer.style.minHeight = '500px';
                }
                
                // å¦‚æœå­˜åœ¨æ—©å…ˆçš„ç½‘ç»œå›¾å®ä¾‹ï¼Œé”€æ¯å®ƒ
                if (window.network) {
                    console.log("é”€æ¯ç°æœ‰ç½‘ç»œå›¾å®ä¾‹");
                    try {
                        window.network.destroy();
                    } catch (e) {
                        console.error("é”€æ¯ç°æœ‰ç½‘ç»œå›¾æ—¶å‡ºé”™:", e);
                    }
                    window.network = null;
                }
                
                // ä¿®æ”¹æ•°æ®ç»“æ„ï¼Œåˆ›å»ºèšåˆèŠ‚ç‚¹
                console.log("åˆ›å»ºèšåˆèŠ‚ç‚¹æ•°æ®ç»“æ„");
                let aggregatedNodes = [];
                let aggregatedEdges = [];
                
                // æ‰¾åˆ°ä¸­å¿ƒèŠ‚ç‚¹
                const centerNode = data.nodes.find(node => node.isRoot || node.group === 'root');
                if (centerNode) {
                    aggregatedNodes.push({
                        id: centerNode.id,
                        label: centerNode.label,
                        color: centerNode.color,
                        font: { size: 20, color: '#333' },
                        size: 30,
                        isRoot: true,
                        group: 'root'
                    });
                } else if (data.nodes.length > 0) {
                    // å¦‚æœæ²¡æœ‰æ˜ç¡®çš„ä¸­å¿ƒèŠ‚ç‚¹ï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ªèŠ‚ç‚¹
                    const firstNode = data.nodes[0];
                    aggregatedNodes.push({
                        id: firstNode.id,
                        label: firstNode.label,
                        color: '#FF9800',
                        font: { size: 20, color: '#333' },
                        size: 30,
                        isRoot: true,
                        group: 'root'
                    });
                } else {
                    console.error("æ— æ³•æ‰¾åˆ°ä¸­å¿ƒèŠ‚ç‚¹");
                    return;
                }
                
                // åˆ›å»ºèšåˆèŠ‚ç‚¹å’Œå®ƒä»¬çš„è¾¹
                const relationTypes = ['synonym', 'antonym', 'related', 'topic'];
                const relationColors = {
                    'synonym': '#4CAF50',
                    'antonym': '#F44336',
                    'related': '#2196F3',
                    'topic': '#9C27B0'
                };
                const relationLabels = {
                    'synonym': 'åŒä¹‰',
                    'antonym': 'åä¹‰',
                    'related': 'ç›¸å…³',
                    'topic': 'ä¸»é¢˜'
                };
                
                // æŒ‰ç±»å‹åˆ†ç»„èŠ‚ç‚¹
                const groupedNodes = {};
                relationTypes.forEach(type => {
                    groupedNodes[type] = data.nodes.filter(node => node.group === type);
                });
                
                // ä¸ºæ¯ä¸ªéç©ºç»„åˆ›å»ºä¸€ä¸ªèšåˆèŠ‚ç‚¹
                relationTypes.forEach(type => {
                    if (groupedNodes[type].length > 0) {
                        // åˆ›å»ºè¯¥ç±»å‹çš„èšåˆèŠ‚ç‚¹
                        const nodeLabel = groupedNodes[type].length > 1 
                            ? groupedNodes[type].map(n => n.label).join('\n')
                            : groupedNodes[type][0].label;
                        
                        const aggregateId = `${type}_group`;
                        aggregatedNodes.push({
                            id: aggregateId,
                            label: nodeLabel,
                            color: relationColors[type],
                            shape: 'box',
                            font: { size: 14, color: '#333', multi: 'html' },
                            size: 20 + (groupedNodes[type].length * 2),
                            group: type,
                            title: `${relationLabels[type]}è¯: ${groupedNodes[type].map(n => n.label).join(', ')}`
                        });
                        
                        // åˆ›å»ºä»ä¸­å¿ƒèŠ‚ç‚¹åˆ°èšåˆèŠ‚ç‚¹çš„è¾¹
                        aggregatedEdges.push({
                            from: centerNode.id,
                            to: aggregateId,
                            label: relationLabels[type],
                            color: {
                                color: relationColors[type],
                                highlight: '#FFB74D'
                            },
                            width: 3,
                            arrows: {
                                to: { enabled: true, scaleFactor: 0.5 }
                            }
                        });
                    }
                });
                
                // æ£€æµ‹å½“å‰æ˜¯å¦ä¸ºæš—è‰²æ¨¡å¼
                const isDarkMode = document.documentElement.classList.contains('dark-mode');
                
                // æ ¹æ®ä¸»é¢˜æ¨¡å¼è®¾ç½®å›¾è°±é¢œè‰²
                const backgroundColor = isDarkMode ? '#1e1e1e' : '#f8f9fa';
                const fontColor = isDarkMode ? '#f1f1f1' : '#333333';
                const edgeFontColor = isDarkMode ? '#e0e0e0' : '#666666';
                
                // ç½‘ç»œå›¾é…ç½®é€‰é¡¹
                const options = {
                    nodes: {
                        shape: 'box',
                        font: {
                            face: 'Noto Sans SC',
                            size: 14,
                            color: fontColor
                        },
                        borderWidth: 2,
                        shadow: true
                    },
                    edges: {
                        width: 2,
                        selectionWidth: 3,
                        smooth: {
                            type: 'continuous',
                            forceDirection: 'none'
                        },
                        font: {
                            face: 'Noto Sans SC',
                            size: 12,
                            align: 'middle',
                            color: edgeFontColor
                        }
                    },
                    physics: {
                        enabled: true,
                        stabilization: {
                            enabled: true,
                            iterations: 100,
                            fit: true
                        },
                        barnesHut: {
                            gravitationalConstant: -2000,
                            centralGravity: 0.1,
                            springLength: 150,
                            springConstant: 0.04,
                            damping: 0.09
                        }
                    },
                    interaction: {
                        hover: true,
                        tooltipDelay: 300,
                        zoomView: true,
                        dragView: true
                    },
                    layout: {
                        improvedLayout: true,
                        hierarchical: {
                            enabled: false
                        }
                    },
                    groups: {
                        // ä¸ºå„ç§èŠ‚ç‚¹ç±»å‹å®šä¹‰æ ·å¼
                        root: {
                            shape: 'circle',
                            color: {
                                background: '#FF9800',
                                border: '#E65100'
                            },
                            size: 30,
                            font: {
                                size: 18,
                                color: fontColor
                            }
                        },
                        synonym: {
                            shape: 'box',
                            color: {
                                background: '#4CAF50',
                                border: '#2E7D32'
                            }
                        },
                        antonym: {
                            shape: 'box',
                            color: {
                                background: '#F44336',
                                border: '#C62828'
                            }
                        },
                        related: {
                            shape: 'box',
                            color: {
                                background: '#2196F3',
                                border: '#1565C0'
                            }
                        },
                        topic: {
                            shape: 'box',
                            color: {
                                background: '#9C27B0',
                                border: '#6A1B9A'
                            }
                        }
                    }
                };
                
                console.log("åˆ›å»ºç½‘ç»œå›¾å®ä¾‹");
                // è®¾ç½®å›¾è°±å®¹å™¨èƒŒæ™¯é¢œè‰²
                graphContainer.style.backgroundColor = backgroundColor;
                
                // è¾“å‡ºå®¹å™¨å°ºå¯¸ä¿¡æ¯ç”¨äºè°ƒè¯•
                console.log("å›¾è°±å®¹å™¨å°ºå¯¸:", graphContainer.clientWidth, "x", graphContainer.clientHeight);
                
                // åˆ›å»ºç½‘ç»œå›¾
                try {
                    // ä½¿ç”¨èšåˆçš„èŠ‚ç‚¹å’Œè¾¹åˆ›å»ºæ•°æ®é›†
                    let visData = { 
                        nodes: new vis.DataSet(aggregatedNodes), 
                        edges: new vis.DataSet(aggregatedEdges) 
                    };
                    
                    // è®°å½•ç”¨äºè°ƒè¯•
                    console.log("èšåˆåçš„èŠ‚ç‚¹æ•°é‡:", aggregatedNodes.length);
                    console.log("èšåˆåçš„è¾¹æ•°é‡:", aggregatedEdges.length);
                    
                    // å°è¯•åˆ›å»ºç½‘ç»œå›¾
                    console.log("å¼€å§‹åˆ›å»ºç½‘ç»œå›¾å®ä¾‹...");
                    let visualNetwork = new vis.Network(
                        graphContainer, 
                        visData, 
                        options
                    );
                    
                    window.network = visualNetwork;
                    window.visData = visData; // ä¿å­˜æ•°æ®å¼•ç”¨ä»¥ä¾¿åç»­ä½¿ç”¨
                    console.log("ç½‘ç»œå›¾å®ä¾‹åˆ›å»ºæˆåŠŸ");
                    
                    // å¯é äº‹ä»¶ç›‘å¬
                    visualNetwork.on('stabilizationProgress', function(params) {
                        console.log('ç¨³å®šåŒ–è¿›åº¦:', params.iterations, '/', params.total);
                    });
                    
                    visualNetwork.on('stabilizationIterationsDone', function() {
                        console.log('å›¾è°±ç¨³å®šåŒ–å®Œæˆ');
                        showLoading(false);
                    });
                    
                    visualNetwork.on('stabilized', function() {
                        console.log("ç½‘ç»œå›¾å·²ç¨³å®š");
                        if (graphStatus) {
                            graphStatus.textContent = "å›¾è°±åŠ è½½å®Œæˆ";
                            setTimeout(function() {
                                graphStatus.style.display = "none";
                            }, 2000);
                        }
                    });
                    
                    // æ·»åŠ èŠ‚ç‚¹ç‚¹å‡»äº‹ä»¶
                    visualNetwork.on('click', function(params) {
                        if (params.nodes && params.nodes.length > 0) {
                            const nodeId = params.nodes[0];
                            const node = visData.nodes.get(nodeId);
                            
                            if (node && node.id.includes('_group')) {
                                // å½“ç‚¹å‡»åˆ†ç»„èŠ‚ç‚¹æ—¶ï¼Œæ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
                                alert(`${node.title}`);
                            } else if (node && !node.isRoot) {
                                // å¯ä»¥é€‰æ‹©å°†éæ ¹èŠ‚ç‚¹è®¾ä¸ºæ–°çš„ç„¦ç‚¹
                                const focusWordInput = document.getElementById('focusWordInput');
                                if (focusWordInput) {
                                    focusWordInput.value = node.label.split('\n')[0]; // ä½¿ç”¨ç¬¬ä¸€ä¸ªå•è¯
                                }
                            }
                        }
                    });
                    
                    // æ·»åŠ æ‚¬åœæç¤º
                    visualNetwork.on('hoverNode', function(params) {
                        try {
                            const nodeId = params.node;
                            const node = visData.nodes.get(nodeId);
                            
                            if (node) {
                                // åœ¨æ§åˆ¶å°æ˜¾ç¤ºèŠ‚ç‚¹ä¿¡æ¯ï¼Œç”¨äºè°ƒè¯•
                                console.log("æ‚¬åœèŠ‚ç‚¹:", node);
                                
                                // æ˜¾ç¤ºèŠ‚ç‚¹ä¿¡æ¯
                                const tooltip = document.getElementById('nodeTooltip');
                                if (tooltip) {
                                    let tooltipContent = '';
                                    
                                    if (node.isRoot) {
                                        tooltipContent = `<div style="font-weight:600; color:${node.color}; font-size:16px;">
                                            ${node.label}
                                        </div>
                                        <div>ä¸­å¿ƒè¯</div>`;
                                    } else {
                                        tooltipContent = `<div style="font-weight:600; color:${node.color}; font-size:16px;">
                                            ${node.title || node.label}
                                        </div>`;
                                    }
                                    
                                    tooltip.innerHTML = tooltipContent;
                                    
                                    // å®šä½æç¤ºæ¡†
                                    const pointer = params.event.center;
                                    tooltip.style.left = `${pointer.x + 10}px`;
                                    tooltip.style.top = `${pointer.y + 10}px`;
                                    tooltip.style.visibility = 'visible';
                                    tooltip.style.opacity = '1';
                                }
                            }
                        } catch (e) {
                            console.error("æ˜¾ç¤ºèŠ‚ç‚¹æç¤ºæ—¶å‡ºé”™:", e);
                        }
                    });
                    
                    // ç§»å‡ºèŠ‚ç‚¹æ—¶éšè—æç¤º
                    visualNetwork.on('blurNode', function() {
                        const tooltip = document.getElementById('nodeTooltip');
                        if (tooltip) {
                            tooltip.style.visibility = 'hidden';
                            tooltip.style.opacity = '0';
                        }
                    });
                    
                } catch (error) {
                    console.error("åˆ›å»ºç½‘ç»œå›¾å®ä¾‹æ—¶å‡ºé”™:", error);
                    alert("åˆ›å»ºå›¾è°±æ—¶å‡ºé”™: " + error.message);
                    
                    // è®°å½•æ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
                    console.error("é”™è¯¯è¯¦æƒ…:", {
                        message: error.message,
                        stack: error.stack,
                        data: {
                            nodes: aggregatedNodes.length,
                            edges: aggregatedEdges.length,
                            container: graphContainer ? {
                                width: graphContainer.clientWidth,
                                height: graphContainer.clientHeight,
                                display: graphContainer.style.display
                            } : 'missing'
                        }
                    });
                    
                    // å°è¯•å¤‡ç”¨çš„ç®€å•æ˜¾ç¤º
                    showSimpleView();
                }
            } catch (error) {
                console.error("åˆ›å»ºç½‘ç»œå›¾æ—¶å‡ºé”™:", error);
                alert("åˆ›å»ºç½‘ç»œå›¾æ—¶å‡ºé”™: " + error.message + "\nè¯·æ£€æŸ¥æ§åˆ¶å°ä»¥è·å–è¯¦ç»†ä¿¡æ¯ã€‚");
                
                // å°è¯•å¤‡ç”¨çš„ç®€å•æ˜¾ç¤º
                showSimpleView();
            }
        }
        
        // æ·»åŠ ä¸€ä¸ªå¤‡ç”¨çš„ç®€å•æ˜¾ç¤ºå‡½æ•°
        function showSimpleView() {
            console.log("åˆ‡æ¢åˆ°ç®€å•è¡¨æ ¼è§†å›¾");
            const simpleView = document.querySelector('.simple-graph-view');
            const graphContainer = document.getElementById('graphContainer');
            
            if (simpleView && graphContainer) {
                simpleView.style.display = 'block';
                graphContainer.style.display = 'none';
                
                // æ›´æ–°è§†å›¾åˆ‡æ¢æŒ‰é’®æ–‡æœ¬
                const viewToggleBtn = document.getElementById('viewToggleBtn');
                if (viewToggleBtn) {
                    viewToggleBtn.textContent = 'å°è¯•å›¾è°±è§†å›¾';
                }
            }
        }
        
        // æ›´æ–°å›¾è°±ç»Ÿè®¡ä¿¡æ¯
        function updateGraphStats(data) {
            try {
                const nodeCountElement = document.getElementById('statNodeCount');
                const edgeCountElement = document.getElementById('statEdgeCount');
                const clusterCountElement = document.getElementById('statClusterCount');
                
                if (nodeCountElement) {
                    nodeCountElement.textContent = data.nodes.length;
                }
                
                if (edgeCountElement) {
                    edgeCountElement.textContent = data.edges.length;
                }
                
                if (clusterCountElement) {
                    // è®¡ç®—ç°‡æ•°ï¼ˆä¼°ç®—å€¼ï¼‰
                    const clusterCount = Math.max(1, Math.ceil(data.nodes.length / 5));
                    clusterCountElement.textContent = clusterCount;
                }
            } catch (e) {
                console.error("æ›´æ–°å›¾è°±ç»Ÿè®¡ä¿¡æ¯æ—¶å‡ºé”™:", e);
            }
        }
        
        // ç”Ÿæˆå­¦ä¹ è·¯å¾„
        function generateLearningPath(data) {
            // è·å–å­¦ä¹ è·¯å¾„å®¹å™¨å…ƒç´ 
            const learningPathContainer = document.getElementById('learningPath');
            
            // å¦‚æœå®¹å™¨ä¸å­˜åœ¨ï¼Œåˆ™è®°å½•é”™è¯¯å¹¶é€€å‡º
            if (!learningPathContainer) {
                console.error("æ‰¾ä¸åˆ°å­¦ä¹ è·¯å¾„å®¹å™¨å…ƒç´  #learningPath");
                return;
            }
            
            // æ¸…ç©ºç°æœ‰è·¯å¾„
            learningPathContainer.innerHTML = '';
            
            try {
                // åŸºäºèŠ‚ç‚¹æ’åºï¼Œä½†ä¸è€ƒè™‘æ ‡è®°çŠ¶æ€
                const pathNodes = [...data.nodes].sort((a, b) => {
                    // è®¡ç®—èŠ‚ç‚¹è¿æ¥æ•°ï¼ˆä»£è¡¨å•è¯çš„å…³è”å¼ºåº¦ï¼‰
                    const aConnections = data.edges.filter(e => 
                        e.from === a.id || e.to === a.id).length;
                    const bConnections = data.edges.filter(e => 
                        e.from === b.id || e.to === b.id).length;
                    
                    // ç®€å•è¯ï¼ˆå…³è”å¤šï¼‰ä¼˜å…ˆ
                    return bConnections - aConnections;
                });
                
                // åˆ›å»ºè·¯å¾„å…ƒç´ 
                pathNodes.slice(0, 10).forEach((node, index) => {
                    const pathItem = document.createElement('span');
                    pathItem.className = 'path-item';
                    pathItem.textContent = node.label;
                    
                    // æ·»åŠ åˆ°è·¯å¾„å®¹å™¨
                    learningPathContainer.appendChild(pathItem);
                    
                    // æ·»åŠ ç®­å¤´ï¼ˆé™¤äº†æœ€åä¸€é¡¹ï¼‰
                    if (index < pathNodes.length - 1 && index < 9) {
                        const arrow = document.createElement('span');
                        arrow.className = 'path-arrow';
                        arrow.textContent = 'â†’';
                        learningPathContainer.appendChild(arrow);
                    }
                    
                    // ä¿®æ”¹ç‚¹å‡»äº‹ä»¶ï¼šå¯¼èˆªåˆ°add_wordé¡µé¢å¹¶é¢„å¡«å•è¯
                    pathItem.addEventListener('click', function() {
                        const word = node.id;
                        // é‡å®šå‘åˆ°add_wordé¡µé¢å¹¶é€šè¿‡URLå‚æ•°ä¼ é€’å•è¯
                        window.location.href = `/add_word?word=${encodeURIComponent(word)}`;
                    });
                });
            } catch (e) {
                console.error("ç”Ÿæˆå­¦ä¹ è·¯å¾„æ—¶å‡ºé”™:", e);
                // åœ¨å®¹å™¨ä¸­æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                learningPathContainer.innerHTML = '<div style="color:#F44336;">ç”Ÿæˆå­¦ä¹ è·¯å¾„æ—¶å‡ºé”™</div>';
            }
        }
        
        // æ˜¾ç¤º/éšè—åŠ è½½åŠ¨ç”»
        function showLoading(show) {
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (!loadingOverlay) {
                console.error("æ‰¾ä¸åˆ°åŠ è½½åŠ¨ç”»overlayå…ƒç´ ");
                return;
            }
            
            if (show) {
                loadingOverlay.style.display = 'flex';
                // æ·»åŠ é˜²æ­¢ç‚¹å‡»ç©¿é€
                document.querySelector('.graph-container').style.pointerEvents = 'none';
            } else {
                loadingOverlay.style.display = 'none';
                // æ¢å¤ç‚¹å‡»äº‹ä»¶
                document.querySelector('.graph-container').style.pointerEvents = 'auto';
            }
        }
    </script>
</body>
</html> 